---
title: CLI Command Execution Flow
description: Complete flow from user input through CLI to handler to workflow to services
---

# CLI Command Execution Flow

## Overview

This diagram shows the complete execution flow when a user runs a CLI command, from input parsing through handler execution, workflow orchestration, service calls, and result formatting.

## Key Concepts

- **Thin Adapters**: CLI handlers are thin - parse args, call workflow, format output
- **No Orchestration in CLI**: Multi-step logic lives in workflows
- **CommandContext**: Provides services via lazy initialization
- **Error Handling**: Centralized in executor
- **Output Formatting**: Handled by executor, not handlers

## Diagram

```mermaid
sequenceDiagram
    participant User
    participant Commander as Commander.js
    participant Registry as Command Registry
    participant Execute as execute()
    participant Handler as Handler
    participant Workflow as Workflow
    participant Service as Service
    participant Storage as Storage/APIs

    User->>Commander: quantbot ingestion ohlcv --from 2024-01-01
    Commander->>Registry: Lookup command 'ingestion ohlcv'
    Registry-->>Commander: Command definition with schema & handler
    
    Commander->>Execute: execute(commandDef, options)
    Execute->>Execute: Normalize options
    Execute->>Execute: Validate args with Zod schema
    Execute->>Execute: Create CommandContext
    Execute->>Execute: Ensure storage initialized
    
    Execute->>Handler: handler(validatedArgs, ctx)
    Handler->>Handler: Normalize types (ISO strings â†’ Date)
    Handler->>Handler: Get service from ctx.services.ohlcvIngestion()
    Handler->>Workflow: Call workflow with spec
    
    Workflow->>Workflow: Validate spec with Zod
    Workflow->>Workflow: Use WorkflowContext for dependencies
    Workflow->>Service: service.ingestForCalls(...)
    
    Service->>Storage: Fetch data from ClickHouse/DuckDB
    Storage-->>Service: Return data
    Service-->>Workflow: Return result
    
    Workflow-->>Handler: Return JSON-serializable result
    Handler-->>Execute: Return result
    
    Execute->>Execute: Format output (table/json/csv)
    Execute->>Execute: Write artifacts (run manifest, CSV)
    Execute-->>User: Display formatted output
```

## Error Handling Flow

```mermaid
graph TD
    start[User runs command] --> validate[Validate args with Zod]
    validate -->|invalid| error1[ValidationError]
    validate -->|valid| createCtx[Create CommandContext]
    createCtx -->|fails| error2[ConfigurationError]
    createCtx -->|success| callHandler[Call handler]
    callHandler -->|throws| catchError[Catch error in execute]
    catchError --> formatError[Format error message]
    formatError --> exit[process.exit 1]
    callHandler -->|success| formatOutput[Format output]
    formatOutput --> success[Display result]
```

## Related Documentation

- [CLI Architecture](../../packages/cli/docs/CLI_ARCHITECTURE.md)
- [WORKFLOW_ARCHITECTURE.md](../WORKFLOW_ARCHITECTURE.md)
- [ARCHITECTURE.md](../ARCHITECTURE.md)

