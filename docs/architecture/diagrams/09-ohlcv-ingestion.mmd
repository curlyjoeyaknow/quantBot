---
title: OHLCV Ingestion Flow
description: Complete OHLCV ingestion flow showing offline vs online separation, rate limiting, and caching
---

# OHLCV Ingestion Flow

## Overview

This diagram shows the complete OHLCV ingestion flow, highlighting the separation between offline work planning and online API fetching, rate limiting, caching, and deduplication.

## Key Concepts

- **Offline Planning**: Generate worklist from DuckDB (no API calls)
- **Online Orchestration**: Jobs service handles API calls, rate limiting
- **Rate Limiting**: Respect API limits with backoff
- **Caching**: ClickHouse for fast queries, DuckDB for analytics
- **Deduplication**: Prevent duplicate fetches

## Diagram

```mermaid
flowchart TD
    start[CLI Command<br/>quantbot ingestion ohlcv] --> handler[Handler<br/>Parse args, get service]
    handler --> workflow[OHLCV Ingestion Workflow]
    
    workflow --> generateWorklist[Generate Worklist<br/>Query DuckDB calls_d<br/>Find missing candles]
    generateWorklist --> filterWorklist[Filter Worklist<br/>Exclude already fetched<br/>Respect date range]
    
    filterWorklist --> jobsService[Jobs Service<br/>Online orchestration]
    jobsService --> rateLimiter[Rate Limiter<br/>Respect API limits]
    
    rateLimiter --> loopStart{For each work item}
    loopStart --> checkCache[Check ClickHouse cache<br/>candles_1m, candles_5m]
    checkCache -->|cached| skip[Skip fetch]
    checkCache -->|not cached| fetchApi[Fetch from Birdeye API<br/>API Client]
    
    fetchApi -->|success| validate[Validate response<br/>Zod schema]
    fetchApi -->|rate limit| backoff[Exponential backoff<br/>Wait and retry]
    backoff --> fetchApi
    
    validate --> storeClickhouse[Store in ClickHouse<br/>candles_1m or candles_5m]
    storeClickhouse --> storeDuckdb[Store in DuckDB<br/>ohlcv_candles_d]
    
    storeDuckdb --> nextItem{More items?}
    nextItem -->|yes| loopStart
    nextItem -->|no| complete[Complete]
    
    skip --> nextItem
    complete --> result[Return Result<br/>JSON-serializable]
    
    style start fill:#e1f5ff
    style generateWorklist fill:#d4edda
    style jobsService fill:#fff3cd
    style fetchApi fill:#f8d7da
    style storeClickhouse fill:#d1ecf1
    style storeDuckdb fill:#d1ecf1
```

## Offline vs Online Separation

```mermaid
graph TB
    subgraph offline[Offline Packages - No API Calls]
        ingestion[@quantbot/ingestion<br/>Worklist generation<br/>DuckDB queries]
        ohlcv[@quantbot/ohlcv<br/>Candle queries<br/>ClickHouse/DuckDB]
    end

    subgraph online[Online Packages - API Calls]
        jobs[@quantbot/jobs<br/>API orchestration<br/>Rate limiting<br/>Metrics]
        apiClients[@quantbot/api-clients<br/>Birdeye client<br/>Helius client]
    end

    ingestion -->|generates worklist| jobs
    jobs -->|fetches data| apiClients
    apiClients -->|stores data| ohlcv
    ohlcv -->|queries data| ingestion
```

## Related Documentation

- [OHLCV_ARCHITECTURE.md](../OHLCV_ARCHITECTURE.md)
- [WORKFLOW_ARCHITECTURE.md](../WORKFLOW_ARCHITECTURE.md)
- [README.md](../../README.md) - OHLCV Data Management

