---
title: Simulation Workflow E2E
description: Complete simulation workflow from CLI command through handler, workflow, simulation service, to results
---

# Simulation Workflow E2E

## Overview

This diagram shows the complete end-to-end flow for running a simulation, highlighting Gate 2 compliance (causal candle access) and the separation between pure simulation and I/O operations.

## Key Concepts

- **Gate 2 Compliance**: Causal candle access prevents future data leakage
- **Pure Simulation**: Simulation engine has no I/O, clocks, or global config
- **Causal Candle Accessor**: Filters candles by closeTime <= simulationTime
- **Workflow Orchestration**: Workflow coordinates I/O, simulation is pure compute

## Diagram

```mermaid
sequenceDiagram
    participant CLI as CLI Command
    participant Handler as Handler
    participant Workflow as Simulation Workflow
    participant Service as Simulation Service
    participant CausalAccessor as Causal Candle Accessor
    participant Storage as Storage Engine
    participant Simulation as Simulation Engine
    participant Results as Results Storage

    CLI->>Handler: quantbot simulation run --strategy MyStrategy
    Handler->>Handler: Parse and validate args
    Handler->>Handler: Get simulation service from ctx
    Handler->>Workflow: Call simulation workflow
    
    Workflow->>Workflow: Validate spec with Zod
    Workflow->>Workflow: Create WorkflowContext
    Workflow->>Service: service.runSimulation(spec)
    
    Service->>Service: Query calls from DuckDB
    Service->>CausalAccessor: Get candles for each call
    
    loop For each call
        CausalAccessor->>Storage: Query candles where closeTime <= call.alertTime
        Storage-->>CausalAccessor: Return filtered candles
        CausalAccessor-->>Service: Return causal candles
    end
    
    Service->>Simulation: simulateStrategy(candles, strategy)
    Note over Simulation: Pure compute<br/>No I/O<br/>No clocks<br/>Deterministic
    
    Simulation->>Simulation: Process candles incrementally
    Simulation->>Simulation: Update indicators
    Simulation->>Simulation: Check entry/exit signals
    Simulation->>Simulation: Calculate PnL
    
    Simulation-->>Service: Return simulation trace
    Service->>Results: Store simulation run
    Service->>Results: Store simulation results
    Results-->>Service: Confirm storage
    Service-->>Workflow: Return JSON-serializable result
    Workflow-->>Handler: Return result
    Handler-->>CLI: Return result
    CLI->>CLI: Format and display output
```

## Gate 2 Compliance

```mermaid
graph TD
    subgraph causal[Causal Candle Accessor]
        query[Query candles from storage]
        filter[Filter: closeTime <= simulationTime]
        cache[Cache results]
        return[Return filtered candles]
    end

    subgraph simulation[Simulation Engine]
        currentTime[Current simulation time]
        getCandles[Get candles at time]
        process[Process candle]
        updateTime[Increment time]
    end

    currentTime --> getCandles
    getCandles --> query
    query --> filter
    filter -->|closeTime <= currentTime| cache
    filter -->|closeTime > currentTime| reject[Reject future candle]
    cache --> return
    return --> process
    process --> updateTime
    updateTime --> currentTime

    style filter fill:#d4edda
    style reject fill:#f8d7da
```

## Related Documentation

- [SIMULATION_CONTRACT.md](../SIMULATION_CONTRACT.md)
- [DETERMINISM.md](../DETERMINISM.md)
- [determinism-gates.md](../determinism-gates.md)
- [WORKFLOW_ARCHITECTURE.md](../WORKFLOW_ARCHITECTURE.md)

