name: Release Quality Gates

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        type: string
  push:
    branches:
      - 'release/**'

jobs:
  pre-release-checks:
    name: Pre-Release Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Build packages (ordered)
        run: pnpm build:ordered

      - name: Type check
        run: pnpm typecheck

      - name: Verify architecture boundaries (AST)
        run: pnpm verify:boundaries-ast

      - name: Check for live trading code
        run: pnpm check:no-live-trading

      - name: Verify PythonEngine usage
        run: pnpm verify:python-engine

      - name: Verify handler tests
        run: pnpm verify:handler-tests

      - name: Verify property tests
        run: pnpm verify:property-tests

      - name: Verify CHANGELOG
        run: pnpm verify:changelog

      - name: Verify documentation
        run: pnpm verify:documentation

      - name: Run smoke tests
        run: pnpm test:smoke

  stress-tests:
    name: Stress Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages (ordered)
        run: pnpm build:ordered

      - name: Run stress tests
        run: pnpm test:stress
        continue-on-error: true

      - name: Run database stress tests
        env:
          RUN_DB_STRESS: 1
        run: pnpm test:stress:db
        continue-on-error: true

      - name: Run chaos engineering tests
        env:
          RUN_CHAOS_TESTS: 1
        run: pnpm test:stress:chaos
        continue-on-error: true

      - name: Run integration stress tests
        env:
          RUN_INTEGRATION_STRESS: 1
        run: pnpm test:stress:all
        continue-on-error: true

      - name: Upload stress test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: stress-test-results-${{ github.run_id }}
          path: |
            packages/*/coverage/
          retention-days: 30

  coverage-verification:
    name: Coverage Verification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages (ordered)
        run: pnpm build:ordered

      - name: Generate coverage report
        run: pnpm test:coverage

      - name: Check coverage meets thresholds
        run: |
          echo "Coverage thresholds: 60% minimum"
          pnpm check:coverage-decrease || echo "Coverage check failed, but continuing..."

      - name: Check coverage decrease
        run: pnpm check:coverage-decrease

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          fail_ci_if_error: false

  documentation-review:
    name: Documentation Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify all documentation is up to date
        run: pnpm verify:documentation

      - name: Check for breaking changes documentation
        run: |
          if grep -r "BREAKING" CHANGELOG.md || grep -r "breaking" CHANGELOG.md; then
            echo "Breaking changes detected. Verifying migration guides exist..."
            # Check if migration guides exist
            if [ ! -f "docs/migration/" ] && [ ! -f "docs/guides/migration.md" ]; then
              echo "⚠️  Breaking changes detected but no migration guide found"
              echo "Consider adding a migration guide in docs/migration/ or docs/guides/"
            fi
          fi

  changelog-verification:
    name: Changelog Verification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify CHANGELOG has version section
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ]; then
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "unreleased")
          fi
          echo "Checking for version: $VERSION"
          if ! grep -q "\[$VERSION\]" CHANGELOG.md && ! grep -q "\[Unreleased\]" CHANGELOG.md; then
            echo "❌ CHANGELOG.md missing version section for $VERSION"
            exit 1
          fi

      - name: Verify all changes are documented
        run: pnpm verify:changelog

      - name: Check format compliance
        run: |
          # Check for Keep a Changelog format
          if ! grep -q "## \[Unreleased\]" CHANGELOG.md && ! grep -q "## \[.*\]" CHANGELOG.md; then
            echo "❌ CHANGELOG.md does not follow Keep a Changelog format"
            exit 1
          fi

      - name: Verify breaking changes are marked
        run: |
          if grep -qi "breaking" CHANGELOG.md; then
            if ! grep -qi "BREAKING" CHANGELOG.md && ! grep -qi "### Changed" CHANGELOG.md; then
              echo "⚠️  Breaking changes detected but may not be properly marked"
            fi
          fi


