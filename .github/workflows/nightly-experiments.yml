name: Nightly Experiments

# Run full backtest suite nightly for regression detection
on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run experiments on'
        required: false
        default: 'develop'
        type: string
      run_full_suite:
        description: 'Run full optimization suite'
        required: false
        default: false
        type: boolean

jobs:
  backtest-regression:
    name: Backtest Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'develop' }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-backtest-${{ hashFiles('tools/backtest/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-backtest-

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install pytest duckdb pyarrow pandas numpy scipy

      - name: Run all backtest tests
        id: backtest
        run: |
          cd tools/backtest
          python -m pytest tests/ -v --tb=short --ignore=tests/test_duckdb_storage.py 2>&1 | tee test-output.txt
          echo "test_exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Run golden tests specifically
        run: |
          cd tools/backtest
          python -m pytest tests/test_path_quality_golden.py tests/test_existing_metric_stability.py -v --tb=long

      - name: Generate test summary
        if: always()
        run: |
          echo "## Nightly Backtest Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.event.inputs.branch || 'develop' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f tools/backtest/test-output.txt ]; then
            echo "### Test Output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 tools/backtest/test-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-backtest-results-${{ github.run_id }}
          path: |
            tools/backtest/test-output.txt
            tools/backtest/results/
          retention-days: 30

  metric-stability:
    name: Metric Stability Check
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'develop' }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install pytest duckdb pyarrow pandas numpy

      - name: Run metric stability tests
        run: |
          cd tools/backtest
          python -m pytest tests/test_existing_metric_stability.py -v --tb=long

      - name: Verify path quality metrics
        run: |
          cd tools/backtest
          python -m pytest tests/test_path_quality_golden.py -v --tb=long

  optimizer-sanity:
    name: Optimizer Sanity Check
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: github.event.inputs.run_full_suite == 'true' || github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'develop' }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install duckdb pyarrow pandas numpy scipy tqdm

      - name: Run optimizer smoke test
        run: |
          cd tools/backtest
          # Run a minimal optimization to verify the pipeline works
          echo "Running optimizer sanity check..."
          python -c "
          from lib.optimizer import GridOptimizer
          from lib.optimizer_config import OptimizerConfig
          from lib.optimizer_objective import ObjectiveConfig
          print('Optimizer imports successful')
          # Verify ObjectiveConfig has new path quality fields
          cfg = ObjectiveConfig()
          assert hasattr(cfg, 'retention_bonus_weight'), 'Missing retention_bonus_weight'
          assert hasattr(cfg, 'headfake_penalty_weight'), 'Missing headfake_penalty_weight'
          print('Path quality config fields verified')
          "

      - name: Verify objective function
        run: |
          cd tools/backtest
          python -c "
          from lib.optimizer_objective import (
              compute_retention_bonus,
              compute_giveback_penalty,
              compute_time_quality_penalty,
              compute_headfake_penalty,
              QualityFilterConfig
          )
          print('All path quality functions imported successfully')
          
          # Test quality filter
          qf = QualityFilterConfig(min_retention=0.5, max_headfake_rate=0.3)
          print(f'QualityFilterConfig: {qf}')
          "

  typescript-tests:
    name: TypeScript Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'develop' }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build:ordered

      - name: Run full test suite
        run: pnpm test:coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: nightly
          fail_ci_if_error: false

  nightly-summary:
    name: Nightly Summary
    runs-on: ubuntu-latest
    needs: [backtest-regression, metric-stability, typescript-tests]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Nightly Experiment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.event.inputs.branch || 'develop' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backtest Regression | ${{ needs.backtest-regression.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Metric Stability | ${{ needs.metric-stability.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript Tests | ${{ needs.typescript-tests.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check for failures
        if: needs.backtest-regression.result == 'failure' || needs.metric-stability.result == 'failure'
        run: |
          echo "::error::Nightly experiments detected regressions!"
          echo "Check the artifacts for detailed test output."
          exit 1

