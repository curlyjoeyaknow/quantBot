name: Test & Lint

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-format:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install pnpm
        run: npm install -g pnpm@10
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Check formatting
        run: pnpm run format:check
      
      - name: Lint
        run: pnpm run lint
      
      - name: Type check
        run: pnpm run typecheck

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install pnpm
        run: npm install -g pnpm@10
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run unit tests
        run: pnpm run test:unit
  
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: quantbot
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: quantbot_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      clickhouse:
        image: clickhouse/clickhouse-server:latest
        ports:
          - 8123:8123
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install pnpm
        run: npm install -g pnpm@10
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run integration tests
        run: pnpm run test:integration
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: quantbot
          POSTGRES_PASSWORD: test_password
          POSTGRES_DATABASE: quantbot_test
          CLICKHOUSE_HOST: localhost
          CLICKHOUSE_PORT: 8123
          CLICKHOUSE_USER: default
          CLICKHOUSE_PASSWORD: ''
          CLICKHOUSE_DATABASE: quantbot_test
  
  test-properties:
    name: Property & Fuzzing Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install pnpm
        run: npm install -g pnpm@10
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run property tests
        run: pnpm run test:properties
      
      - name: Run fuzzing tests
        run: pnpm run test:fuzzing
  
  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: quantbot
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: quantbot_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      clickhouse:
        image: clickhouse/clickhouse-server:latest
        ports:
          - 8123:8123
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install pnpm
        run: npm install -g pnpm@10
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run tests with coverage
        run: pnpm run test:coverage
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: quantbot
          POSTGRES_PASSWORD: test_password
          POSTGRES_DATABASE: quantbot_test
          CLICKHOUSE_HOST: localhost
          CLICKHOUSE_PORT: 8123
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
      
      - name: Check coverage thresholds
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            node -e "
              const coverage = require('./coverage/coverage-summary.json');
              const total = coverage.total;
              if (total.lines.pct < 80) {
                console.error('❌ Line coverage below 80%:', total.lines.pct);
                process.exit(1);
              }
              if (total.functions.pct < 80) {
                console.error('❌ Function coverage below 80%:', total.functions.pct);
                process.exit(1);
              }
              console.log('✅ Coverage thresholds met');
            "
          fi
  
  cli-quality:
    name: CLI Quality Gate
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install pnpm
        run: npm install -g pnpm@10
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build CLI package
        run: pnpm --filter @quantbot/cli build
      
      - name: Type check CLI
        run: pnpm --filter @quantbot/cli typecheck
      
      - name: Lint CLI
        run: pnpm --filter @quantbot/cli lint
      
      - name: Format check CLI
        run: pnpm --filter @quantbot/cli format:check
      
      - name: Run CLI tests (including smoke test)
        run: pnpm --filter @quantbot/cli test --run
      
      - name: Run CLI command registry smoke test
        run: pnpm --filter @quantbot/cli test command-registry-smoke.test.ts --run
      
      - name: Verify all CLI handlers have tests
        run: |
          # Ensure smoke test passes (catches missing handlers/tests)
          pnpm --filter @quantbot/cli test command-registry-smoke.test.ts --run || exit 1
          echo "✅ All CLI commands properly registered and testable"

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install pnpm
        run: npm install -g pnpm@10
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run security audit
        run: pnpm audit --audit-level=moderate
      
      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

