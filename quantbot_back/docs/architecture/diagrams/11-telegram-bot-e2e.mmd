---
title: Telegram Bot E2E Flow
description: Complete flow from Telegram user message through bot, command parsing, handlers, workflows to response
---

# Telegram Bot E2E Flow

## Overview

This diagram shows the proposed end-to-end flow for the Telegram bot, from user message through Telegraf, command parsing, handlers, workflows, to formatted response.

## Key Concepts

- **Command Pattern**: Each command has its own handler class
- **Session Management**: Track user state and session expiration
- **Dependency Injection**: All services injected via DI container
- **User-Friendly Errors**: Errors formatted for Telegram users
- **Workflow Integration**: Bot commands call same workflows as CLI

## Diagram

```mermaid
sequenceDiagram
    participant User as Telegram User
    participant Telegram as Telegram API
    participant Telegraf as Telegraf Bot
    participant Parser as Command Parser
    participant Handler as Command Handler
    participant Session as Session Service
    participant Workflow as Workflow
    participant Service as Service
    participant Storage as Storage

    User->>Telegram: Send message: /backtest MyStrategy
    Telegram->>Telegraf: Webhook event
    Telegraf->>Telegraf: Parse message
    Telegraf->>Parser: Extract command and args
    
    Parser->>Session: Get or create session
    Session->>Session: Check expiration
    Session-->>Parser: Return session
    
    Parser->>Handler: Route to handler<br/>BacktestCommandHandler
    Handler->>Handler: Validate command args
    Handler->>Handler: Get services from DI container
    
    Handler->>Workflow: Call simulation workflow<br/>Same as CLI
    Workflow->>Service: service.runSimulation(...)
    Service->>Storage: Query calls, fetch candles
    Storage-->>Service: Return data
    Service->>Service: Run simulation
    Service-->>Workflow: Return result
    
    Workflow-->>Handler: Return JSON result
    Handler->>Handler: Format for Telegram<br/>Markdown, emojis
    Handler->>Session: Update session state
    Handler->>Telegraf: Send formatted message
    Telegraf->>Telegram: Send response
    Telegram->>User: Display message
```

## Command Handler Pattern

```mermaid
graph TB
    subgraph bot[Telegram Bot]
        telegraf[Telegraf Bot<br/>Webhook handler]
        middleware[Middleware<br/>Logging, error handling]
        router[Command Router<br/>Map commands to handlers]
    end

    subgraph handlers[Command Handlers]
        backtestHandler[BacktestCommandHandler<br/>/backtest]
        strategyHandler[StrategyCommandHandler<br/>/strategy]
        analysisHandler[AnalysisCommandHandler<br/>/analysis]
        monitoringHandler[MonitoringCommandHandler<br/>/alerts]
    end

    subgraph services[Services via DI]
        sessionService[SessionService<br/>State management]
        workflowService[WorkflowService<br/>Call workflows]
        storageService[StorageService<br/>Database access]
    end

    subgraph workflows[Workflows]
        simulationWorkflow[Simulation Workflow]
        analyticsWorkflow[Analytics Workflow]
        monitoringWorkflow[Monitoring Workflow]
    end

    telegraf --> middleware
    middleware --> router
    router --> backtestHandler
    router --> strategyHandler
    router --> analysisHandler
    router --> monitoringHandler

    backtestHandler --> sessionService
    backtestHandler --> workflowService
    strategyHandler --> sessionService
    strategyHandler --> storageService
    analysisHandler --> workflowService
    monitoringHandler --> workflowService

    workflowService --> simulationWorkflow
    workflowService --> analyticsWorkflow
    workflowService --> monitoringWorkflow
```

## Session Management

```mermaid
stateDiagram-v2
    [*] --> NewSession: User sends first message
    NewSession --> Active: Session created
    Active --> Active: User sends commands
    Active --> Expired: Timeout (e.g., 30 min)
    Expired --> NewSession: User sends new message
    Active --> Cancelled: User sends /cancel
    Cancelled --> NewSession: User sends new message
```

## Related Documentation

- [Bot Rules](../../.cursor/rules/bot.mdc)
- [WORKFLOW_ARCHITECTURE.md](../WORKFLOW_ARCHITECTURE.md)
- [README.md](../../README.md) - Telegram Bot Commands

