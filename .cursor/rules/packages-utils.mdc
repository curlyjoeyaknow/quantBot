---
description: Utils package rules - shared utilities, event system, Zod validation
globs:
  - "packages/utils/**/*.ts"
  - "packages/utils/**/*.js"
alwaysApply: false
---

# Utils Package Rules

## Shared Utilities
- Event system: `@quantbot/utils/events`
- Common helpers for all packages
- Zero dependencies where possible

## Code Style
- Pure functions preferred
- Type-safe utilities
- Well-documented with JSDoc

## Testing
- Unit tests for all utilities
- Test edge cases
- Mock external dependencies

## EventBus Patterns
- **Async handlers**: Use `Promise.all()` with `listeners()` to await all async handlers
- Don't rely on EventEmitter's synchronous emit - explicitly await handlers
- Wrap handlers in try/catch to prevent one failure from breaking others

## Database Utilities (Deprecated)
- ⚠️ Database functions are deprecated - use `@quantbot/storage` instead
- Tests mock validation to focus on database operations
- Use proper Zod schema structure in test data (type, percent, etc. for strategies)

## Zod Validation
- For Zod 4.x: access errors via `result.error.issues` (not `.errors`)
- Handle both `issues` and legacy `errors` for compatibility
