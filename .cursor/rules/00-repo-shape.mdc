---
name: Repo shape and boundaries (QuantBot)
description: Enforce monorepo layout, keep runtime state out of git, and make entrypoints obvious (truth → policy → optimize).
globs:
  - "**/*"
alwaysApply: true
---

# Repo shape (non-negotiable)

QuantBot is a **caller-centric backtesting lab** (truth layer → policy layer → optimization layer). Structure is how we prevent architectural drift.

## The only allowed top-level code directories

- `apps/` = runnable entrypoints ONLY (CLI, daemons, web server, workers)
- `packages/` = libraries ONLY (no process wiring, no direct I/O)
- `docs/` = architecture + status notes (no trophy files in root)
- `tools/` = developer-only tooling (scripts used by developers/CI)

Nothing else at top-level is allowed to become a “soft app” or “mini repo”.

## Apps vs Packages (hard boundary)

### `apps/*` rules

Apps are composition roots and I/O boundaries:

- parse CLI args / HTTP requests
- load env/config (at the edge)
- wire ports/adapters into handlers
- run the process lifecycle
- emit logs/metrics/telemetry

Apps MUST NOT contain business logic:

- no path metrics math
- no stop/exit evaluation logic
- no optimization logic

### `packages/*` rules

Packages are libraries:

- pure domain logic
- ports/interfaces
- handlers/use-cases
- adapters (if you keep adapters in packages)

Packages MUST NOT:

- read env vars directly
- own process lifecycle
- act as a server/daemon entrypoint
- spawn background loops
- write runtime state into the repo

## Runtime state must not live in-repo

Never create or rely on these folders **inside** the repo:

- `logs/`, `data/`, `.pids/`, `backups/`, `cache/`, `tmp/`

If persistence is required, implement:

- configurable external paths (env var / CLI flag)
- safe defaults that point OUTSIDE the repo (OS-appropriate state directories)

### Required defaults (recommended)

When no explicit path is provided:

- Linux: `$XDG_STATE_HOME/quantbot` or `~/.local/state/quantbot`
- macOS: `~/Library/Application Support/quantbot`
- Windows: `%LOCALAPPDATA%\\quantbot`

### Mandatory path knobs

Any component that needs a file path MUST be configurable via:

- env vars (for apps): e.g. `QUANTBOT_STATE_DIR`, `DUCKDB_PATH`
- CLI flags (for CLI app): e.g. `--state-dir`, `--duckdb-path`

> Repo-local paths may be used only in tests (temporary directories) and must never be a production default.

## Entrypoints (must be obvious)

Every runnable app must have a single obvious entrypoint:

- `apps/<app-name>/src/main.ts` (or `main.rs` for Rust)

No mystery root-level `src/`. No “server.ts” hiding in a package as an app.

## Monorepo workspace hygiene

- `packages/*` are importable units.
- `apps/*` depend on packages; packages must not depend on apps.
- Cross-cutting behavior goes into a package, not copy-pasted into multiple apps.

## Worktrees (practical rule)

Worktrees are expected. Therefore:

- Never assume global-installed commands (`quantbot`) point to the correct checkout.
- Apps should execute binaries via the workspace (`pnpm -C <root> exec -- ...`) or an explicit path override (`QUANTBOT_CLI`), not PATH roulette.

## Transitional note (current repo reality)

If runnable entrypoints still live under `packages/` (e.g. `packages/cli`, `packages/lab-ui`), treat them as **legacy**.
New runnable services MUST start life in `apps/*`, and legacy ones should migrate there when touched.
EOF
