---
description: Command handler rules for src/commands/ directory
globs: ["src/commands/**/*.ts", "quantbot-bot/src/commands/**/*.ts"]
alwaysApply: true
---

# Command Handler Rules (src/commands/)

## Command Handler Architecture

core-principles:
  - All commands must implement `CommandHandler` interface
  - Commands should be self-contained and testable
  - Use dependency injection for services
  - Validate all inputs before processing
  - Return structured responses

handler-structure:
- One handler class per command
- Handlers should be stateless
- Use services for business logic
- Keep handlers focused on command execution
- Handle errors gracefully

## Command Implementation

command-registration:
- Register commands in `CommandRegistry`
- Use consistent command naming
- Document command usage
- Provide help text
- Handle command aliases

command-execution:
- Parse command arguments
- Validate input parameters
- Execute command logic
- Format response appropriately
- Handle errors with user-friendly messages

command-responses:
- Return structured response objects
- Use consistent response format
- Include relevant data
- Format messages for Telegram
- Handle long responses appropriately

## Input Validation

parameter-validation:
- Validate all command parameters
- Use Zod schemas for validation
- Provide helpful error messages
- Handle missing parameters
- Validate parameter types

data-validation:
- Validate input data formats
- Check data ranges
- Validate required fields
- Handle invalid data gracefully
- Provide validation feedback

## Error Handling

user-facing-errors:
- Provide clear error messages
- Don't expose internal errors
- Suggest corrective actions
- Handle common errors gracefully
- Log errors for debugging

internal-errors:
- Log errors with context
- Use appropriate error types
- Handle errors at appropriate levels
- Don't crash on errors
- Implement error recovery

## Service Integration

service-usage:
- Inject services via constructor
- Use async/await for service calls
- Handle service errors appropriately
- Cache service responses when needed
- Monitor service performance

dependency-injection:
- Use service container
- Inject dependencies explicitly
- Avoid global state
- Make dependencies testable
- Document dependencies

## Testing

unit-tests:
- Test handlers independently
- Mock service dependencies
- Test input validation
- Test error handling
- Test response formatting

integration-tests:
- Test full command flows
- Test with real services
- Test error scenarios
- Test state management
- Test user interactions

## Documentation

command-documentation:
- Document all commands
- Provide usage examples
- Document parameters
- Include error scenarios
- Keep documentation current

code-documentation:
- Document handler logic
- Explain validation rules
- Document error handling
- Include examples
- Keep comments updated

