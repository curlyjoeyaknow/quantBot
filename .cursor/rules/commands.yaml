---
description: Command handler rules for src/commands/ directory
globs: ["src/commands/**/*.ts", "quantbot-bot/src/commands/**/*.ts"]
alwaysApply: true
---

# Command Handler Rules (src/commands/)

## Command Handler Architecture

core-principles:
  implement-command-handler-interface:
    - "All commands must implement `CommandHandler` interface"
  be-self-contained-and-testable:
    - "Commands must be self-contained and testable"
  use-dependency-injection-for-services:
    - "Commands must use dependency injection for services"
  validate-inputs-before-processing:
    - "Commands must validate all inputs before processing"
  return-structured-responses:
    - "Commands must return structured responses"
  handle-errors-gracefully:
    - "Commands must handle errors gracefully"
  log-command-execution:
    - "Commands must log command execution"

handler-structure:
  one-handler-class-per-command:
    - "Commands must have one handler class per command"
  handlers-should-be-stateless:
    - "Handlers must be stateless"
  use-services-for-business-logic:
    - "Handlers must use services for business logic"
  keep-handlers-focused-on-command-execution:
    - "Handlers must keep focused on command execution"
  handle-errors-gracefully:
    - "Handlers must handle errors gracefully"
  log-command-execution:
    - "Handlers must log command execution"
  implement-command-caching:
    - "Handlers must implement command caching"
  implement-command-rate-limiting:
    - "Handlers must implement command rate limiting"
  implement-command-throttling:
    - "Handlers must implement command throttling"
  implement-command-batching:
    - "Handlers must implement command batching"

## Command Implementation

command-responses:
  return-structured-response-objects:
    - "Commands must return structured response objects"
  use-consistent-response-format:
    - "Commands must use consistent response format"
  include-relevant-data:
    - "Commands must include relevant data"
  format-messages-for-telegram:
    - "Commands must format messages for Telegram"
  handle-long-responses-appropriately:
    - "Commands must handle long responses appropriately"

## Input Validation

parameter-validation:
  validate-all-command-parameters:
    - "Commands must validate all command parameters"
  use-zod-schemas-for-validation:
    - "Commands must use Zod schemas for validation"
  provide-helpful-error-messages:
    - "Commands must provide helpful error messages"
  handle-missing-parameters:
    - "Commands must handle missing parameters"
  validate-parameter-types:
    - "Commands must validate parameter types"

data-validation:
  validate-input-data-formats:
    - "Commands must validate input data formats"
  check-data-ranges:
    - "Commands must check data ranges"
  validate-required-fields:
    - "Commands must validate required fields"
  handle-invalid-data-gracefully:
    - "Commands must handle invalid data gracefully"
  provide-validation-feedback:
    - "Commands must provide validation feedback"

## Error Handling

user-facing-errors:
  provide-clear-error-messages:
    - "Commands must provide clear error messages"
  do-not-expose-internal-errors:
    - "Commands must not expose internal errors"
  suggest-corrective-actions:
    - "Commands must suggest corrective actions"
  handle-common-errors-gracefully:
    - "Commands must handle common errors gracefully"
  log-errors-for-debugging:
    - "Commands must log errors for debugging"

internal-errors:
  log-errors-with-context:
    - "Commands must log errors with context"
  use-appropriate-error-types:
    - "Commands must use appropriate error types"
  handle-errors-at-appropriate-levels:
    - "Commands must handle errors at appropriate levels"
  do-not-crash-on-errors:
    - "Commands must not crash on errors"
  implement-error-recovery:
    - "Commands must implement error recovery"

## Service Integration

service-usage:
  inject-services-via-constructor:
    - "Commands must inject services via constructor"
  use-async-await-for-service-calls:
    - "Commands must use async/await for service calls"
  handle-service-errors-appropriately:
    - "Commands must handle service errors appropriately"
  cache-service-responses-when-needed:
    - "Commands must cache service responses when needed"
  monitor-service-performance:
    - "Commands must monitor service performance"

dependency-injection:
  use-service-container:
    - "Commands must use service container"
  inject-dependencies-explicitly:
    - "Commands must inject dependencies explicitly"
  avoid-global-state:
    - "Commands must avoid global state"
  make-dependencies-testable:
    - "Commands must make dependencies testable"
  document-dependencies:
    - "Commands must document dependencies"

## Testing

unit-tests:
  test-handlers-independently:
    - "Commands must test handlers independently"
  mock-service-dependencies:
    - "Commands must mock service dependencies"
  test-input-validation:
    - "Commands must test input validation"
  test-error-handling:
    - "Commands must test error handling"
  test-response-formatting:
    - "Commands must test response formatting"

integration-tests:
  test-full-command-flows:
    - "Commands must test full command flows"
  test-with-real-services:
    - "Commands must test with real services"
  test-error-scenarios:
    - "Commands must test error scenarios"
  test-state-management:
    - "Commands must test state management"
  test-user-interactions:
    - "Commands must test user interactions"

## Documentation

command-documentation:
  document-all-commands:
    - "Commands must document all commands"
  provide-usage-examples:
    - "Commands must provide usage examples"
  document-parameters:
    - "Commands must document parameters"
  include-error-scenarios:
    - "Commands must include error scenarios"
  keep-documentation-current:
    - "Commands must keep documentation current"

code-documentation:
  document-handler-logic:
    - "Commands must document handler logic"
  explain-validation-rules:
    - "Commands must explain validation rules"
  document-error-handling:
    - "Commands must document error handling"
  include-usage-examples:
    - "Commands must include usage examples"
  keep-documentation-current:
    - "Commands must keep documentation current"
  keep-comments-updated:
    - "Commands must keep comments updated"

