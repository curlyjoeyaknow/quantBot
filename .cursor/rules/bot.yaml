---
description: Essential Telegram bot rules for src/bot/ and quantbot-bot/
globs: ["src/bot/**/*.ts", "quantbot-bot/**/*.ts", "src/bot.ts"]
alwaysApply: true
---

# Essential Bot Rules

# Core Architecture
bot-architecture:
  use-telegraf: "Use Telegraf for Telegram bot interactions"
  command-pattern: "Implement the command pattern for handlers"
  dependency-injection: "Use dependency injection for all bot services"
  separate-bot-vs-business-logic: "Keep bot logic separate from business logic"
  user-friendly-error-handling: "Handle errors gracefully and display user-friendly messages"

# Initialization and Middleware
bot-initialization:
  proper-config: "Initialize bot with proper configuration"
  register-commands: "Register command handlers centrally"
  setup-middleware: "Use middleware for shared logic and logging"
  error-handling: "Configure and centralize error handling"

# Command Handlers
command-handlers:
  one-class-per-command: "Each command has its own handler class"
  implements-interface: "Handlers must implement a CommandHandler interface"
  validate-input: "Validate and sanitize all user inputs"
  structured-responses: "Return structured and consistent responses"

# Message and Response
message-processing:
  consistent-parsing: "Parse and extract commands/arguments consistently"
  async-processing: "Process messages asynchronously"
  concise-responses: "Responses should be concise and use Markdown formatting if needed"

# Error Handling
error-handling:
  user-friendly-errors: "User-facing errors must not expose internals"
  log-details-internally: "Log all error context internally without crashing the bot"
  handle-rate-limit: "Gracefully handle Telegram API rate limiting"

# State Management
state-management:
  session-service: "Use a SessionService for session and state handling, including expiration"
  clean-user-state: "Track and securely store/clean state when needed"

# Integration
integration:
  use-service-container: "Inject all services using a DI container"
  api-clients: "Access external APIs via client classes (with retry and caching if needed)"
  handle-api-errors: "Handle remote errors gracefully"

# Testing
testing:
  unit-test-handlers: "Unit test handlers and edge cases, mock services/deps"
  test-errors: "Test error and input validation"
  test-core-integration: "Test critical integrations (API, session, state)"

# Documentation (Minimum)
documentation:
  document-architecture: "Document bot architecture, key handlers, and state/session/routing"
  doc-commands: "Document all commands and their arguments, error cases, and provide usage examples"
  keep-updated: "Keep documentation and examples up-to-date"

