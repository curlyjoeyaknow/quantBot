# DateTime Handling - UTC ONLY (MANDATORY)

## The Golden Rule

**ALL datetime operations MUST use UTC. NEVER use local timezone.**

This rule is non-negotiable. Timezone bugs have caused data corruption.

## Python - Use DateTimeController

Location: `tools/shared/datetime_controller.py`

### BANNED Functions (NEVER USE)

```python
# ❌ BANNED - Uses local timezone
datetime.now()
datetime.fromtimestamp(ts)
datetime.fromisoformat(s)  # without TZ handling
time.localtime()

# ❌ BANNED - Timezone-naive operations
dt.isoformat()  # without ensuring UTC first
```

### REQUIRED Usage

```python
from tools.shared.datetime_controller import dt

# Current time
now = dt.now()  # ✅ Returns UTC

# Timestamp (ms) to datetime
dt_obj = dt.from_timestamp_ms(1714521600000)  # ✅ Returns UTC

# Timestamp (s) to datetime
dt_obj = dt.from_timestamp_s(1714521600)  # ✅ Returns UTC

# Datetime to ISO string
iso = dt.to_iso(dt_obj)  # ✅ Returns "2024-05-01T00:00:00Z"

# Parse ISO string
dt_obj = dt.from_iso("2024-05-01T00:00:00Z")  # ✅ Returns UTC

# Datetime to timestamp (ms)
ts = dt.to_timestamp_ms(dt_obj)  # ✅ Returns int

# ClickHouse format
ch_str = dt.to_clickhouse_format(dt_obj)  # ✅ Returns "2024-05-01 00:00:00"
```

## TypeScript - Use DateTimeController

Location: `@quantbot/utils` → `datetime-controller.ts`

### BANNED Patterns (NEVER USE)

```typescript
// ❌ BANNED - Implicit local timezone
new Date().toISOString()  // risky
Date.parse(str)  // risky
moment()  // deprecated, use Luxon

// ❌ BANNED - Luxon without explicit zone
DateTime.now()  // Uses local TZ!
DateTime.fromISO(str)  // May use local TZ!
```

### REQUIRED Usage

```typescript
import { dt } from '@quantbot/utils';

// Current time
const now = dt.now();  // ✅ Returns UTC DateTime

// Timestamp (ms) to DateTime
const dtObj = dt.fromTimestampMs(1714521600000);  // ✅ Returns UTC

// Timestamp (s) to DateTime
const dtObj = dt.fromTimestampS(1714521600);  // ✅ Returns UTC

// DateTime to ISO string
const iso = dt.toISO(dtObj);  // ✅ Returns "2024-05-01T00:00:00.000Z"

// Parse ISO string
const dtObj = dt.fromISO("2024-05-01T00:00:00Z");  // ✅ Returns UTC

// DateTime to timestamp (ms)
const ts = dt.toTimestampMs(dtObj);  // ✅ Returns number

// ClickHouse format
const ch = dt.toClickHouseFormat(dtObj);  // ✅ Returns "2024-05-01 00:00:00"
```

## Timestamp Units

QuantBot uses **milliseconds** for all internal timestamps.

```typescript
// ✅ CORRECT
const ts = 1714521600000;  // milliseconds
const dt = dt.fromTimestampMs(ts);

// ❌ WRONG - seconds, not milliseconds
const ts = 1714521600;  // This is SECONDS!
// Use assertTimestampMs(ts) to catch this bug
```

Use `assertTimestampMs(value)` to validate timestamps are in milliseconds.

## ISO String Format

All ISO strings MUST end with `Z` (UTC indicator):

```
✅ "2024-05-01T00:00:00Z"
✅ "2024-05-01T00:00:00.123Z"
❌ "2024-05-01T00:00:00"        (missing TZ)
❌ "2024-05-01T00:00:00+10:00"  (non-UTC)
❌ "2024-05-01 00:00:00"        (not ISO format)
```

## ClickHouse Format

ClickHouse uses `YYYY-MM-DD HH:mm:ss` format (no timezone):

```
✅ "2024-05-01 00:00:00"
```

Always convert to UTC before formatting for ClickHouse.

## Code Review Checklist

When reviewing datetime code:

- [ ] No `datetime.now()` or `datetime.fromtimestamp()` in Python
- [ ] No `DateTime.now()` without `{ zone: 'utc' }` in TypeScript
- [ ] All ISO strings end with 'Z'
- [ ] All timestamps are in milliseconds (use `assertTimestampMs`)
- [ ] Using DateTimeController (`dt`) for all conversions

## Why This Matters

On a UTC+10 machine, `datetime.fromtimestamp(ts)` returns local time.
If you then add 'Z' suffix, you're **lying about the timezone**.

This caused OHLCV data to be fetched 10 hours late, corrupting the dataset.

**Use DateTimeController. Always.**
