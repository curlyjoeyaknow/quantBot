---
description: QuantBot workflow testing rules - Vitest, independence, coverage requirements
globs:
  - "packages/workflows/tests/**"
  - "packages/workflows/src/**"
alwaysApply: false
---

# Workflow Testing Rules

> **See also:** `debugging-regression-tests.mdc` for mandatory regression test creation after bug fixes.

## Test Structure

- Workflows tests validate orchestration behavior using mocked WorkflowContext
- Required: `packages/workflows/tests/unit/`
- Optional: `packages/workflows/tests/fixtures/`

## Test Coverage

Unit tests must cover:

1. Success path (dryRun true and false)
2. Missing strategy → fails fast (throws or returns structured error)
3. Invalid date range (to <= from) → validation failure
4. No calls found → empty run, no persistence, summary reflects zeros
5. Per-call errors → collected and returned, workflow continues
6. Summary stats correctness (counts, pnl aggregation, etc.)

## Mocking Contract

Use mocked WorkflowContext:

- `ctx.repos.strategies.getByName()`
- `ctx.repos.calls.listCalls()`
- `ctx.ohlcv.getCandles()` / `ctx.ohlcv.fetchCandles()`
- `ctx.repos.simulationRuns.create()`
- `ctx.repos.simulationResults.bulkInsert()`
- `ctx.clock.now()`

No real:

- Postgres/ClickHouse clients
- Axios/fetch
- Filesystem

## Independence

Forbidden in tests:

- Importing fee/rounding calculators from production modules
- Importing constants from simulation for expected values

Allowed:

- Local helper inside test file (only used by tests)
- Hard-coded numeric expectations

Rule: If production math changes, tests should FAIL unless behavior is truly unchanged.

## Coverage Requirements

- Add `@vitest/coverage-v8` as devDependency
- Configure vitest to collect coverage for `packages/workflows/src/**`

Minimum thresholds:

- Lines: 85%
- Branches: 75%
- Functions: 80%
- Statements: 85%
