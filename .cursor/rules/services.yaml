---
description: Service layer rules for src/services/ directory
globs: ["src/services/**/*.ts", "quantbot-bot/src/services/**/*.ts"]
alwaysApply: true
---

# Service Rules (src/services/)

service-architecture:

core-principles:  
    - "Services should be stateless when possible"
    - "Use dependency injection for testability"
    - "Implement proper error handling"
    - "Validate all inputs"
    - "Log important operations"

service-structure:
    - "One service class per domain"
    - "Services should have single responsibility"
    - "Use interfaces for service contracts"
    - "Keep services focused and cohesive"
    - "Document service responsibilities"

service-implementation:
    - "Inject dependencies via constructor"
    - "Use service container for dependencies"
    - "Avoid circular dependencies"
    - "Document dependencies clearly"
    - "Make dependencies testable" 

domain-services:

ca-detection-service:
    - "Use `CADetectionService` for CA detection"
    - "Validate detection parameters"
    - "Handle detection errors gracefully"
    - "Cache detection results when appropriate"
    - "Log detection operations"

ohlcv-services:
    - "Use `OHLCVEngine` for OHLCV operations"
    - "Cache OHLCV data appropriately"
    - "Handle missing data gracefully"
    - "Validate OHLCV data structure"
    - "Monitor OHLCV operations"

simulation-service:
    - "Use `SimulationService` for simulations"
    - "Validate simulation parameters"
    - "Handle simulation errors"
    - "Log simulation progress"
    - "Return structured results"

strategy-service:
    - "Use `StrategyService` for strategy operations"
    - "Validate strategy definitions"
    - "Handle strategy errors"
    - "Cache strategy data when appropriate"
    - "Log strategy operations"

error-handling:

service-errors:
    - "Use custom error types"
    - "Include context in error messages"
    - "Log errors with appropriate severity"
    - "Handle errors at service level"
    - "Don't expose internal errors"

validation-errors:
    - "Validate inputs early"
    - "Provide helpful validation messages"
    - "Use Zod for validation"
    - "Handle validation errors gracefully"
    - "Document validation rules"

caching:

service-caching:
    - "Cache expensive operations"
    - "Use appropriate cache keys"
    - "Invalidate cache when needed"
    - "Monitor cache performance"
    - "Handle cache errors gracefully"

cache-strategy:
    - "Cache at appropriate levels"
    - "Use appropriate TTLs"
    - "Implement cache warming"
    - "Provide cache statistics"
    - "Document caching decisions"

## Testing

unit-tests:
    - "Test services independently"
    - "Mock dependencies"
    - "Test error handling"
    - "Test validation"
    - "Test caching behavior"

integration-tests:
    - "Test with real dependencies"
    - "Test error scenarios"
    - "Test performance"
    - "Test caching"
    - "Test service interactions"

## Documentation

service-documentation:
    - "Document all services"
    - "Include usage examples"
    - "Document dependencies"
    - "Include error scenarios"
    - "Keep documentation current"

code-documentation:
    - "Document service logic"
    - "Explain business rules"
    - "Document error handling"
    - "Include examples"
    - "Keep comments updated"

