---
description: QuantBot Data Access and Loader Best Practices
globs:
  - "src/data/**/*.ts"
  - "src/simulation/data/**/*.ts"
  - "quantbot-bot/src/data/**/*.ts"
alwaysApply: true
---

# Data Access Layer Architecture

data-access:
  core:
    - "Adopt the data loader pattern for all structured data retrieval."
    - "Support pluggable sources: CSV, ClickHouse, APIs, etc."
    - "Centralize input validation and sanitization."
    - "Maintain strict separation of data access from business logic."
    - "Implement caching (in-memory/Redis) where high performance is needed."
    - "Favor dependency injection for testable loaders."
    - "Handle edge cases and errors consistently."
    - "Expose batch loading interface where relevant."

# Loader Contracts and Implementation Rules

loader:
  interface:
    - "All loaders implement a common DataLoader interface."
    - "Interface must define: load, validate, clearCache methods."
    - "Batch loading must be supported where useful."
    - "Return typed, structured results (discriminated unions or Result<T, E>)."
  implementation:
    - "Use factory pattern for loader instantiation by source type."
    - "Ensure each loader encapsulates its data source (no leakage)."
    - "Constructor injection for all dependencies is required."

# Source-Specific Best Practices

sources:
  csv:
    - "Schema and column validation required upon load."
    - "Handle malformed, missing, or empty files gracefully."
    - "Default to UTF-8 decoding; validate file encoding."
    - "Skip and log incomplete rows."
  clickhouse:
    - "Use parameterized queries for safety."
    - "Validate results against expected schema (shape, types)."
    - "Retry transient errors, validate connection health."
    - "Cache costly queries with sensible TTL."
    - "Log and monitor all query timings."
  external-api:
    - "Isolate remote integration in ApiLoader classes."
    - "Use exponential backoff/retry on remote errors."
    - "Validate and sanitize all inbound responses."
    - "Log API calls and errors with context."
    - "Cache remote responses as needed, respect rate limits and ETags."
  caller:
    - "Validate incoming caller data structure."
    - "Handle missing or incomplete caller data gracefully."
    - "Cache and update caller data as appropriate."

# Data Validation

validation:
  zod:
    - "All input data must be validated with Zod schemas."
    - "Check shapes, types, required fields, data ranges."
    - "Surface comprehensible error messages on validation failure."
    - "Fail fast on critical validation errors."
    - "Document Zod schemas alongside loader code."

# Transformation

transformation:
  - "Consistently transform and normalize raw data."
  - "Handle and document missing or optional fields."
  - "Preserve original data integrity during transformation."

# Caching

caching:
  strategy:
    - "Cache expensive or repeated loads."
    - "Support configurable TTLs based on volatility."
    - "Invalidate cache on source update or data mutation."
    - "Expose cache metrics and handle backend cache errors robustly."
  management:
    - "Clean up expired cache entries regularly."
    - "Provide cache diagnostics and statistics."
    - "Implement cache warming when beneficial."

# Error Handling

error-handling:
  general:
    - "Wrap low-level errors in DataLoaderError or custom error types."
    - "Never leak sensitive or internal details (paths, stacktraces) to the user."
    - "Provide context-rich, user-friendly messages for all errors."
    - "Logging must contain useful context for debugging."
    - "Never crash loader on recoverable/malformed data; log and skip."
    - "Notify and alert on critical loader failures."
    - "Retry transient failures when appropriate; fail gracefully on persistent failures."
    - "Implement fallback strategies where available."

# Testing

testing:
  unit:
    - "Unit test every loader, including edge and error cases."
    - "Mock external dependencies: filesystems, DBs, APIs."
    - "Test invalid, missing, and badly-encoded files."
    - "Test cache invalidation, error propagation."
  integration:
    - "Integration test against real sources in CI (safe fixtures only)."
    - "Exercise code with real-world data quirks and edge cases."
    - "Tests must be deterministic for known data."
    - "Verify caching, error handling, and fallback logic in integration tests."

# Performance

performance:
  loading:
    - "Stream large files where feasible; chunk large datasets."
    - "Batch data loads and queries appropriately."
    - "Optimize memory usage for big loads via chunking."
    - "Profile loaders and eliminate bottlenecks proactively."
    - "Use efficient structures for lookups (Map, Set)."
  queries:
    - "Optimize DB queries, use appropriate indexes."
    - "Minimize data transfer size and round-trips."
    - "Cache repeated query results."
    - "Track query timing for database sources."

# Documentation

docs:
  loaders:
    - "Document each loader, including interface contract and source expectations."
    - "Document all Zod schema shapes, CSV/database column formats."
    - "Include illustrative usage examples for every loader."
    - "Document error and edge cases, and their handling."
    - "Keep comments and documentation current as code changes."
  code:
    - "Explain core loader logic with concise comments."
    - "Document significant data transformations and caching strategies."
    - "Example snippets recommended for non-obvious patterns."

