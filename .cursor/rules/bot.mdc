---
description: Essential Telegram bot rules for src/bot/ and quantbot-bot/ - Telegraf, command pattern, dependency injection
globs:
  - "src/bot/**/*.ts"
  - "quantbot-bot/**/*.ts"
  - "src/bot.ts"
alwaysApply: true
---

# Essential Bot Rules

## Core Architecture

- Use Telegraf for Telegram bot interactions
- Implement command pattern for handlers
- Use dependency injection for all bot services
- Keep bot logic separate from business logic
- Handle errors gracefully with user-friendly messages

## Initialization and Middleware

- Initialize bot with proper configuration
- Register command handlers centrally
- Use middleware for shared logic and logging
- Configure and centralize error handling

## Command Handlers

- Each command has its own handler class
- Handlers must implement a CommandHandler interface
- Validate and sanitize all user inputs
- Return structured and consistent responses

## Message and Response

- Parse and extract commands/arguments consistently
- Process messages asynchronously
- Responses should be concise and use Markdown formatting if needed

## Error Handling

- User-facing errors must not expose internals
- Log all error context internally without crashing the bot
- Gracefully handle Telegram API rate limiting

## State Management

- Use SessionService for session and state handling, including expiration
- Track and securely store/clean state when needed

## Integration

- Inject all services using a DI container
- Access external APIs via client classes (with retry and caching if needed)
- Handle remote errors gracefully

## Testing

- Unit test handlers and edge cases, mock services/deps
- Test error and input validation
- Test critical integrations (API, session, state)

## Documentation

- Document bot architecture, key handlers, and state/session/routing
- Document all commands and their arguments, error cases, and provide usage examples
- Keep documentation and examples up-to-date
