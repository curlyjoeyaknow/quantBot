<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Lab UI — Truth Leaderboard</title>
  <link rel="stylesheet" href="/public/style.css" />
</head>
<body>
  <nav>
    <a href="/dashboard">Dashboard</a>
    <a href="/strategies">Strategies</a>
    <a href="/runs">Runs</a>
    <a href="/leaderboard">Leaderboard</a>
    <a href="/scored">Scored</a>
    <a href="/truth" class="active">Truth</a>
    <a href="/policies">Policies</a>
  </nav>

  <main>
    <h1>Truth Leaderboard (Path-Only Metrics)</h1>
    <p class="hint">
      This shows raw path metrics per caller from a <code>path-only</code> run.
      No policy execution — just the truth about what each caller's tokens did.
    </p>

    <section class="card">
      <h2>Create Path-Only Run</h2>
      <div class="row">
        <label>Interval&nbsp;<select id="interval">
          <option value="1m">1m</option>
          <option value="5m" selected>5m</option>
          <option value="15m">15m</option>
          <option value="1h">1h</option>
        </select></label>
        <label>From&nbsp;<input id="from" type="date" /></label>
        <label>To&nbsp;<input id="to" type="date" /></label>
        <label>Caller Filter&nbsp;<input id="callerFilter" placeholder="optional" /></label>
        <button id="create">Create Run</button>
        <span id="createMsg"></span>
      </div>
    </section>

    <section class="card">
      <div class="row">
        <label>Run ID&nbsp;<input id="runId" placeholder="paste run_id" /></label>
        <button id="load">Load Leaderboard</button>
        <span id="msg"></span>
      </div>
    </section>

    <section class="card">
      <h2>Caller Truth Leaderboard</h2>
      <div class="table-scroll">
        <table id="tbl">
          <thead>
            <tr>
              <th>Caller</th>
              <th>Calls</th>
              <th>2x Rate</th>
              <th>3x Rate</th>
              <th>4x Rate</th>
              <th>Med t2x (min)</th>
              <th>Med t3x (min)</th>
              <th>Med t4x (min)</th>
              <th>Med DD (bps)</th>
              <th>P95 DD (bps)</th>
              <th>Med DD→2x (bps)</th>
              <th>Med alert→act (s)</th>
              <th>Avg Peak (x)</th>
              <th>Med Peak (x)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="hint">
        These are anchored to the alert timestamp, reflecting pure caller quality.
        Use this to decide which callers are worth following before applying policies.
      </p>
    </section>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);

    // Create path-only run
    $("create").onclick = async () => {
      const interval = $("interval").value;
      const from = $("from").value;
      const to = $("to").value;
      const caller_filter = $("callerFilter").value.trim();

      if (!from || !to) {
        $("createMsg").textContent = "from/to required";
        return;
      }

      try {
        const res = await fetch("/api/runs/path-only", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ interval, from, to, caller_filter })
        });
        const data = await res.json();
        if (data.error) {
          $("createMsg").textContent = "Error: " + data.error;
        } else {
          $("createMsg").textContent = "Created: " + data.run_id;
          $("runId").value = data.run_id;
        }
      } catch (e) {
        $("createMsg").textContent = "Error: " + e.message;
      }
    };

    // Load leaderboard
    $("load").onclick = async () => {
      const runId = $("runId").value.trim();
      if (!runId) {
        $("msg").textContent = "enter run_id";
        return;
      }

      try {
        const res = await fetch("/api/truth-leaderboard/" + runId);
        const rows = await res.json();

        const tbody = $("tbl").querySelector("tbody");
        tbody.innerHTML = "";

        if (!rows.length) {
          $("msg").textContent = "no data";
          return;
        }

        for (const r of rows) {
          const tr = document.createElement("tr");
          tr.innerHTML = [
            r.caller_name,
            r.calls,
            fmt(r.rate_2x, 2),
            fmt(r.rate_3x, 2),
            fmt(r.rate_4x, 2),
            fmt(r.median_t2x_min, 1),
            fmt(r.median_t3x_min, 1),
            fmt(r.median_t4x_min, 1),
            fmt(r.median_dd_bps, 0),
            fmt(r.p95_dd_bps, 0),
            fmt(r.median_dd_to_2x_bps, 0),
            fmt(r.median_alert_to_activity_s, 1),
            fmt(r.avg_peak, 2),
            fmt(r.median_peak, 2)
          ].map(v => `<td>${v}</td>`).join("");
          tbody.appendChild(tr);
        }

        $("msg").textContent = rows.length + " callers";
      } catch (e) {
        $("msg").textContent = "Error: " + e.message;
      }
    };

    function fmt(v, decimals) {
      if (v == null) return "–";
      return Number(v).toFixed(decimals);
    }
  </script>
</body>
</html>

