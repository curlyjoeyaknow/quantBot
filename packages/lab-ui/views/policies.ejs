<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Lab UI — Policies</title>
  <link rel="stylesheet" href="/public/style.css" />
</head>
<body>
  <nav>
    <a href="/dashboard">Dashboard</a>
    <a href="/strategies">Strategies</a>
    <a href="/runs">Runs</a>
    <a href="/leaderboard">Leaderboard</a>
    <a href="/scored">Scored</a>
    <a href="/truth">Truth</a>
    <a href="/policies" class="active">Policies</a>
  </nav>

  <main>
    <h1>Policy Optimization</h1>
    <p class="hint">
      Run policy optimization on a path-only run to find the best exit policy for each caller.
      Uses grid search with explicit constraint-based scoring.
    </p>

    <section class="card">
      <h2>Run Policy Backtest</h2>
      <div class="row">
        <label>Path-Only Run ID&nbsp;<input id="pathOnlyRunId" placeholder="run_id from path-only" /></label>
        <label>Caller&nbsp;<input id="callerPolicy" placeholder="caller name" /></label>
      </div>
      <div class="row">
        <label>Policy Type&nbsp;<select id="policyType">
          <option value="fixed-stop">Fixed Stop</option>
          <option value="time-stop">Time Stop</option>
          <option value="trailing-stop">Trailing Stop</option>
          <option value="ladder">Ladder</option>
        </select></label>
        <label>Policy JSON&nbsp;<textarea id="policyJson" rows="4" cols="50">{
  "type": "fixed-stop",
  "stopLossBps": -500,
  "takeProfitBps": 10000
}</textarea></label>
      </div>
      <div class="row">
        <button id="runPolicy">Run Policy Backtest</button>
        <span id="policyMsg"></span>
      </div>
    </section>

    <section class="card">
      <h2>Run Optimizer</h2>
      <div class="row">
        <label>Path-Only Run ID&nbsp;<input id="optRunId" placeholder="run_id from path-only" /></label>
        <label>Caller&nbsp;<input id="optCaller" placeholder="caller name" /></label>
        <label>Policy Type&nbsp;<select id="optPolicyType">
          <option value="fixed-stop">Fixed Stop</option>
          <option value="time-stop">Time Stop</option>
          <option value="trailing-stop">Trailing Stop</option>
        </select></label>
      </div>
      <div class="row">
        <label>Constraints&nbsp;<textarea id="constraintsJson" rows="3" cols="50">{
  "maxStopOutRate": 0.25,
  "maxP95DrawdownBps": 2000,
  "maxTimeExposedMs": 3600000
}</textarea></label>
      </div>
      <div class="row">
        <button id="runOptimize">Run Optimizer</button>
        <span id="optMsg"></span>
      </div>
    </section>

    <section class="card">
      <h2>Best Policies by Caller</h2>
      <div class="row">
        <label>Caller&nbsp;<input id="lookupCaller" placeholder="caller name" /></label>
        <button id="lookupPolicies">Lookup</button>
        <span id="lookupMsg"></span>
      </div>
      <div class="table-scroll">
        <table id="policiesTable">
          <thead>
            <tr>
              <th>Policy ID</th>
              <th>Score</th>
              <th>Policy JSON</th>
              <th>Constraints</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);

    // Run policy backtest
    $("runPolicy").onclick = async () => {
      const path_only_run_id = $("pathOnlyRunId").value.trim();
      const caller_filter = $("callerPolicy").value.trim();
      const policy_json = $("policyJson").value.trim();

      if (!path_only_run_id) {
        $("policyMsg").textContent = "path_only_run_id required";
        return;
      }
      if (!policy_json) {
        $("policyMsg").textContent = "policy_json required";
        return;
      }

      try {
        const res = await fetch("/api/runs/policy", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ path_only_run_id, policy_json, caller_filter })
        });
        const data = await res.json();
        if (data.error) {
          $("policyMsg").textContent = "Error: " + data.error;
        } else {
          $("policyMsg").textContent = "Created policy run: " + data.run_id;
        }
      } catch (e) {
        $("policyMsg").textContent = "Error: " + e.message;
      }
    };

    // Run optimizer
    $("runOptimize").onclick = async () => {
      const path_only_run_id = $("optRunId").value.trim();
      const caller = $("optCaller").value.trim();
      const policy_type = $("optPolicyType").value;
      const constraints_json = $("constraintsJson").value.trim();

      if (!path_only_run_id) {
        $("optMsg").textContent = "path_only_run_id required";
        return;
      }
      if (!caller) {
        $("optMsg").textContent = "caller required";
        return;
      }

      try {
        const res = await fetch("/api/runs/optimize", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ path_only_run_id, caller, policy_type, constraints_json })
        });
        const data = await res.json();
        if (data.error) {
          $("optMsg").textContent = "Error: " + data.error;
        } else {
          $("optMsg").textContent = "Created optimize run: " + data.run_id;
        }
      } catch (e) {
        $("optMsg").textContent = "Error: " + e.message;
      }
    };

    // Lookup best policies
    $("lookupPolicies").onclick = async () => {
      const caller = $("lookupCaller").value.trim();
      if (!caller) {
        $("lookupMsg").textContent = "enter caller name";
        return;
      }

      try {
        const res = await fetch("/api/policies/" + encodeURIComponent(caller));
        const rows = await res.json();

        const tbody = $("policiesTable").querySelector("tbody");
        tbody.innerHTML = "";

        if (!rows.length) {
          $("lookupMsg").textContent = "no policies found";
          return;
        }

        for (const r of rows) {
          const tr = document.createElement("tr");
          tr.innerHTML = [
            r.policy_id,
            r.score?.toFixed(4) ?? "–",
            `<code>${escapeHtml(r.policy_json?.slice(0, 80) ?? "")}</code>`,
            `<code>${escapeHtml(r.constraints_json?.slice(0, 60) ?? "")}</code>`,
            r.created_at
          ].map(v => `<td>${v}</td>`).join("");
          tbody.appendChild(tr);
        }

        $("lookupMsg").textContent = rows.length + " policies";
      } catch (e) {
        $("lookupMsg").textContent = "Error: " + e.message;
      }
    };

    function escapeHtml(str) {
      return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }
  </script>
</body>
</html>

