<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Lab UI — Policies</title>
  <link rel="stylesheet" href="/public/style.css" />
</head>
<body>
  <nav>
    <a href="/strategies">Strategies</a>
    <a href="/runs">Runs</a>
    <a href="/leaderboard">Leaderboard</a>
    <a href="/truth">Truth</a>
    <a href="/policies" class="active">Policies</a>
  </nav>

  <main>
    <h1>Policy Optimization</h1>
    <p class="hint">
      Run policy optimization on a path-only run to find the best exit policy for each caller.
      Uses grid search with explicit constraint-based scoring.
    </p>

    <section class="card">
      <h2>Run Policy Backtest</h2>
      
      <div class="form-group">
        <label>Path-Only Run ID <span class="required">*</span></label>
        <input id="pathOnlyRunId" type="text" placeholder="run_id from path-only run" />
      </div>

      <div class="form-group">
        <label>Caller (optional)</label>
        <input id="callerPolicy" type="text" placeholder="Filter by caller name" />
      </div>

      <div class="form-group">
        <label>Policy Type <span class="required">*</span></label>
        <select id="policyType" class="policy-type-select">
          <option value="fixed_stop">Fixed Stop</option>
          <option value="time_stop">Time Stop</option>
          <option value="trailing_stop">Trailing Stop</option>
          <option value="ladder">Ladder</option>
        </select>
      </div>

      <!-- Fixed Stop Parameters -->
      <div id="fixedStopParams" class="policy-params">
        <div class="form-group">
          <label>Stop Loss % <span class="required">*</span></label>
          <div class="slider-container">
            <input type="range" id="fixedStopPct" min="1" max="50" value="20" step="1" class="slider" />
            <span class="slider-value" id="fixedStopPctValue">20%</span>
          </div>
        </div>
        <div class="form-group">
          <label>Take Profit % (optional)</label>
          <div class="slider-container">
            <input type="range" id="fixedTakeProfitPct" min="0" max="500" value="100" step="5" class="slider" />
            <span class="slider-value" id="fixedTakeProfitPctValue">100%</span>
          </div>
          <label class="checkbox-label">
            <input type="checkbox" id="fixedEnableTakeProfit" /> Enable take profit
          </label>
        </div>
      </div>

      <!-- Time Stop Parameters -->
      <div id="timeStopParams" class="policy-params" style="display: none;">
        <div class="form-group">
          <label>Max Hold Time <span class="required">*</span></label>
          <div class="slider-container">
            <input type="range" id="timeStopHours" min="0.5" max="48" value="1" step="0.5" class="slider" />
            <span class="slider-value" id="timeStopHoursValue">1 hour</span>
          </div>
        </div>
        <div class="form-group">
          <label>Take Profit % (optional)</label>
          <div class="slider-container">
            <input type="range" id="timeTakeProfitPct" min="0" max="500" value="100" step="5" class="slider" />
            <span class="slider-value" id="timeTakeProfitPctValue">100%</span>
          </div>
          <label class="checkbox-label">
            <input type="checkbox" id="timeEnableTakeProfit" /> Enable take profit
          </label>
        </div>
      </div>

      <!-- Trailing Stop Parameters -->
      <div id="trailingStopParams" class="policy-params" style="display: none;">
        <div class="form-group">
          <label>Activation % <span class="required">*</span></label>
          <div class="slider-container">
            <input type="range" id="trailActivationPct" min="5" max="100" value="20" step="1" class="slider" />
            <span class="slider-value" id="trailActivationPctValue">20%</span>
          </div>
          <small>Activate trailing stop after this gain</small>
        </div>
        <div class="form-group">
          <label>Trail % <span class="required">*</span></label>
          <div class="slider-container">
            <input type="range" id="trailPct" min="1" max="50" value="10" step="1" class="slider" />
            <span class="slider-value" id="trailPctValue">10%</span>
          </div>
          <small>Exit if price drops this % from peak</small>
        </div>
        <div class="form-group">
          <label>Hard Stop % (optional)</label>
          <div class="slider-container">
            <input type="range" id="trailHardStopPct" min="1" max="50" value="15" step="1" class="slider" />
            <span class="slider-value" id="trailHardStopPctValue">15%</span>
          </div>
          <label class="checkbox-label">
            <input type="checkbox" id="trailEnableHardStop" /> Enable hard stop
          </label>
          <small>Always active stop loss, independent of trailing</small>
        </div>
      </div>

      <!-- Ladder Parameters -->
      <div id="ladderParams" class="policy-params" style="display: none;">
        <div class="form-group">
          <label>Ladder Levels <span class="required">*</span></label>
          <div id="ladderLevels">
            <!-- Levels will be dynamically added -->
          </div>
          <button type="button" id="addLadderLevel" class="btn-secondary">+ Add Level</button>
        </div>
        <div class="form-group">
          <label>Stop Loss % (optional)</label>
          <div class="slider-container">
            <input type="range" id="ladderStopPct" min="1" max="50" value="20" step="1" class="slider" />
            <span class="slider-value" id="ladderStopPctValue">20%</span>
          </div>
          <label class="checkbox-label">
            <input type="checkbox" id="ladderEnableStop" /> Enable stop loss
          </label>
          <small>Stop loss for remaining position</small>
        </div>
      </div>

      <div class="form-group">
        <label>Execution Settings</label>
        
        <div class="form-row">
          <div class="form-col">
            <label>Taker Fee (bps)</label>
            <input type="number" id="policyTakerFeeBps" min="0" max="10000" value="30" step="1" />
          </div>
          <div class="form-col">
            <label>Slippage (bps)</label>
            <input type="number" id="policySlippageBps" min="0" max="10000" value="10" step="1" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-col">
            <label>Execution Model</label>
            <select id="policyExecutionModel">
              <option value="simple">Simple</option>
              <option value="pumpfun">PumpFun</option>
              <option value="pumpswap">PumpSwap</option>
              <option value="raydium">Raydium</option>
              <option value="minimal">Minimal</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button id="runPolicy" class="btn-primary">Run Policy Backtest</button>
        <span id="policyMsg" class="message"></span>
      </div>
    </section>

    <section class="card">
      <h2>Run Optimizer</h2>
      
      <div class="form-group">
        <label>Path-Only Run ID <span class="required">*</span></label>
        <input id="optRunId" type="text" placeholder="run_id from path-only run" />
      </div>

      <div class="form-group">
        <label>Caller <span class="required">*</span></label>
        <input id="optCaller" type="text" placeholder="Caller name to optimize for" />
      </div>

      <div class="form-group">
        <label>Policy Type <span class="required">*</span></label>
        <select id="optPolicyType" class="policy-type-select">
          <option value="fixed_stop">Fixed Stop</option>
          <option value="time_stop">Time Stop</option>
          <option value="trailing_stop">Trailing Stop</option>
          <option value="ladder">Ladder</option>
        </select>
      </div>

      <div class="form-group">
        <label>Optimizer Constraints</label>
        
        <div class="constraint-group">
          <label>Max Stop-Out Rate</label>
          <div class="slider-container">
            <input type="range" id="maxStopOutRate" min="0" max="100" value="25" step="1" class="slider" />
            <span class="slider-value" id="maxStopOutRateValue">25%</span>
          </div>
          <small>Maximum acceptable stop-out rate (0-100%)</small>
        </div>

        <div class="constraint-group">
          <label>Max P95 Drawdown (bps)</label>
          <div class="slider-container">
            <input type="range" id="maxP95DrawdownBps" min="-5000" max="0" value="-2000" step="50" class="slider" />
            <span class="slider-value" id="maxP95DrawdownBpsValue">-2000 bps</span>
          </div>
          <small>Maximum 95th percentile drawdown in basis points</small>
        </div>

        <div class="constraint-group">
          <label>Max Time Exposed (hours)</label>
          <div class="slider-container">
            <input type="range" id="maxTimeExposedHours" min="1" max="72" value="24" step="1" class="slider" />
            <span class="slider-value" id="maxTimeExposedHoursValue">24 hours</span>
          </div>
          <small>Maximum median time exposed</small>
        </div>
      </div>

      <div class="form-group">
        <label>Execution Settings</label>
        
        <div class="form-row">
          <div class="form-col">
            <label>Taker Fee (bps)</label>
            <input type="number" id="takerFeeBps" min="0" max="10000" value="30" step="1" />
          </div>
          <div class="form-col">
            <label>Slippage (bps)</label>
            <input type="number" id="slippageBps" min="0" max="10000" value="10" step="1" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-col">
            <label>Execution Model</label>
            <select id="executionModel">
              <option value="simple">Simple</option>
              <option value="pumpfun">PumpFun</option>
              <option value="pumpswap">PumpSwap</option>
              <option value="raydium">Raydium</option>
              <option value="minimal">Minimal</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button id="runOptimize" class="btn-primary">Run Optimizer</button>
        <span id="optMsg" class="message"></span>
      </div>
    </section>

    <section class="card">
      <h2>Best Policies by Caller</h2>
      <div class="form-group">
        <label>Caller</label>
        <div class="form-row">
          <input id="lookupCaller" type="text" placeholder="Caller name" />
          <button id="lookupPolicies" class="btn-secondary">Lookup</button>
        </div>
        <span id="lookupMsg" class="message"></span>
      </div>
      <div class="table-scroll">
        <table id="policiesTable">
          <thead>
            <tr>
              <th>Policy ID</th>
              <th>Score</th>
              <th>Policy JSON</th>
              <th>Constraints</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);

    // Update slider value displays
    function setupSlider(sliderId, valueId, formatter) {
      const slider = $(sliderId);
      const value = $(valueId);
      if (slider && value) {
        slider.addEventListener('input', () => {
          value.textContent = formatter(slider.value);
        });
      }
    }

    // Policy type switcher
    $("policyType").addEventListener('change', (e) => {
      const type = e.target.value;
      document.querySelectorAll('.policy-params').forEach(el => el.style.display = 'none');
      
      if (type === 'fixed_stop') {
        $("fixedStopParams").style.display = 'block';
      } else if (type === 'time_stop') {
        $("timeStopParams").style.display = 'block';
      } else if (type === 'trailing_stop') {
        $("trailingStopParams").style.display = 'block';
      } else if (type === 'ladder') {
        $("ladderParams").style.display = 'block';
      }
    });

    // Setup sliders
    setupSlider('fixedStopPct', 'fixedStopPctValue', v => v + '%');
    setupSlider('fixedTakeProfitPct', 'fixedTakeProfitPctValue', v => v + '%');
    setupSlider('timeStopHours', 'timeStopHoursValue', v => v + ' hour' + (v != 1 ? 's' : ''));
    setupSlider('timeTakeProfitPct', 'timeTakeProfitPctValue', v => v + '%');
    setupSlider('trailActivationPct', 'trailActivationPctValue', v => v + '%');
    setupSlider('trailPct', 'trailPctValue', v => v + '%');
    setupSlider('trailHardStopPct', 'trailHardStopPctValue', v => v + '%');
    setupSlider('ladderStopPct', 'ladderStopPctValue', v => v + '%');
    setupSlider('maxStopOutRate', 'maxStopOutRateValue', v => v + '%');
    setupSlider('maxP95DrawdownBps', 'maxP95DrawdownBpsValue', v => v + ' bps');
    setupSlider('maxTimeExposedHours', 'maxTimeExposedHoursValue', v => v + ' hour' + (v != 1 ? 's' : ''));

    // Build policy JSON from form
    function buildPolicyJson() {
      const type = $("policyType").value;
      
      if (type === 'fixed_stop') {
        const policy = {
          kind: 'fixed_stop',
          stopPct: parseFloat($("fixedStopPct").value) / 100
        };
        if ($("fixedEnableTakeProfit").checked) {
          policy.takeProfitPct = parseFloat($("fixedTakeProfitPct").value) / 100;
        }
        return JSON.stringify(policy);
      } else if (type === 'time_stop') {
        const policy = {
          kind: 'time_stop',
          maxHoldMs: parseFloat($("timeStopHours").value) * 60 * 60 * 1000
        };
        if ($("timeEnableTakeProfit").checked) {
          policy.takeProfitPct = parseFloat($("timeTakeProfitPct").value) / 100;
        }
        return JSON.stringify(policy);
      } else if (type === 'trailing_stop') {
        const policy = {
          kind: 'trailing_stop',
          activationPct: parseFloat($("trailActivationPct").value) / 100,
          trailPct: parseFloat($("trailPct").value) / 100
        };
        if ($("trailEnableHardStop").checked) {
          policy.hardStopPct = parseFloat($("trailHardStopPct").value) / 100;
        }
        return JSON.stringify(policy);
      } else if (type === 'ladder') {
        const levels = [];
        const levelElements = document.querySelectorAll('.ladder-level');
        levelElements.forEach(el => {
          const multiple = parseFloat(el.querySelector('.ladder-multiple').value);
          const fraction = parseFloat(el.querySelector('.ladder-fraction').value) / 100;
          levels.push({ multiple, fraction });
        });
        
        const policy = {
          kind: 'ladder',
          levels: levels.sort((a, b) => a.multiple - b.multiple)
        };
        if ($("ladderEnableStop").checked) {
          policy.stopPct = parseFloat($("ladderStopPct").value) / 100;
        }
        return JSON.stringify(policy);
      }
      
      return '{}';
    }

    // Ladder level management
    let ladderLevelCount = 0;
    function addLadderLevel(multiple = 2.0, fraction = 50) {
      const container = $("ladderLevels");
      const div = document.createElement('div');
      div.className = 'ladder-level form-row';
      div.innerHTML = `
        <div class="form-col">
          <label>Multiple (x)</label>
          <input type="number" class="ladder-multiple" min="1" max="100" step="0.1" value="${multiple}" />
        </div>
        <div class="form-col">
          <label>Exit %</label>
          <input type="number" class="ladder-fraction" min="1" max="100" step="1" value="${fraction}" />
        </div>
        <div class="form-col">
          <button type="button" class="btn-remove" onclick="this.parentElement.parentElement.remove()">Remove</button>
        </div>
      `;
      container.appendChild(div);
      ladderLevelCount++;
    }
    
    $("addLadderLevel").addEventListener('click', () => {
      addLadderLevel(2.0 + ladderLevelCount, 50);
    });
    
    // Initialize with one ladder level
    addLadderLevel(2.0, 50);

    // Get execution settings for policy
    function getPolicyExecutionSettings() {
      return {
        taker_fee_bps: parseInt($("policyTakerFeeBps").value) || 30,
        slippage_bps: parseInt($("policySlippageBps").value) || 10,
        execution_model: $("policyExecutionModel").value || 'simple'
      };
    }

    // Run policy backtest
    $("runPolicy").onclick = async () => {
      const path_only_run_id = $("pathOnlyRunId").value.trim();
      const caller_filter = $("callerPolicy").value.trim();
      const policy_json = buildPolicyJson();

      if (!path_only_run_id) {
        $("policyMsg").textContent = "Path-only run ID required";
        $("policyMsg").style.color = 'var(--error)';
        return;
      }

      $("policyMsg").textContent = "Creating run...";
      $("policyMsg").style.color = 'var(--muted)';

      const execSettings = getPolicyExecutionSettings();

      try {
        const res = await fetch("/api/runs/policy", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            path_only_run_id, 
            policy_json, 
            caller_filter: caller_filter || undefined,
            taker_fee_bps: execSettings.taker_fee_bps,
            slippage_bps: execSettings.slippage_bps,
            execution_model: execSettings.execution_model
          })
        });
        const data = await res.json();
        if (data.error) {
          $("policyMsg").textContent = "Error: " + data.error;
          $("policyMsg").style.color = 'var(--error)';
        } else {
          $("policyMsg").textContent = "✓ Created policy run: " + data.run_id;
          $("policyMsg").style.color = 'var(--success)';
        }
      } catch (e) {
        $("policyMsg").textContent = "Error: " + e.message;
        $("policyMsg").style.color = 'var(--error)';
      }
    };

    // Build constraints JSON
    function buildConstraintsJson() {
      return JSON.stringify({
        maxStopOutRate: parseFloat($("maxStopOutRate").value) / 100,
        maxP95DrawdownBps: parseFloat($("maxP95DrawdownBps").value),
        maxTimeExposedMs: parseFloat($("maxTimeExposedHours").value) * 60 * 60 * 1000
      });
    }

    // Get execution settings
    function getExecutionSettings() {
      return {
        taker_fee_bps: parseInt($("takerFeeBps").value) || 30,
        slippage_bps: parseInt($("slippageBps").value) || 10,
        execution_model: $("executionModel").value || 'simple'
      };
    }

    // Run optimizer
    $("runOptimize").onclick = async () => {
      const path_only_run_id = $("optRunId").value.trim();
      const caller = $("optCaller").value.trim();
      const policy_type = $("optPolicyType").value;
      const constraints_json = buildConstraintsJson();

      if (!path_only_run_id) {
        $("optMsg").textContent = "Path-only run ID required";
        $("optMsg").style.color = 'var(--error)';
        return;
      }
      if (!caller) {
        $("optMsg").textContent = "Caller required";
        $("optMsg").style.color = 'var(--error)';
        return;
      }

      $("optMsg").textContent = "Creating optimizer run...";
      $("optMsg").style.color = 'var(--muted)';

      const execSettings = getExecutionSettings();

      try {
        const res = await fetch("/api/runs/optimize", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            path_only_run_id, 
            caller, 
            policy_type, 
            constraints_json,
            taker_fee_bps: execSettings.taker_fee_bps,
            slippage_bps: execSettings.slippage_bps,
            execution_model: execSettings.execution_model
          })
        });
        const data = await res.json();
        if (data.error) {
          $("optMsg").textContent = "Error: " + data.error;
          $("optMsg").style.color = 'var(--error)';
        } else {
          $("optMsg").textContent = "✓ Created optimizer run: " + data.run_id;
          $("optMsg").style.color = 'var(--success)';
        }
      } catch (e) {
        $("optMsg").textContent = "Error: " + e.message;
        $("optMsg").style.color = 'var(--error)';
      }
    };

    // Lookup best policies
    $("lookupPolicies").onclick = async () => {
      const caller = $("lookupCaller").value.trim();
      if (!caller) {
        $("lookupMsg").textContent = "Enter caller name";
        $("lookupMsg").style.color = 'var(--error)';
        return;
      }

      $("lookupMsg").textContent = "Loading...";
      $("lookupMsg").style.color = 'var(--muted)';

      try {
        const res = await fetch("/api/policies/" + encodeURIComponent(caller));
        const rows = await res.json();

        const tbody = $("policiesTable").querySelector("tbody");
        tbody.innerHTML = "";

        if (!rows.length) {
          $("lookupMsg").textContent = "No policies found";
          $("lookupMsg").style.color = 'var(--muted)';
          return;
        }

        for (const r of rows) {
          const tr = document.createElement("tr");
          tr.innerHTML = [
            r.policy_id,
            r.score?.toFixed(4) ?? "–",
            `<code>${escapeHtml(r.policy_json?.slice(0, 80) ?? "")}</code>`,
            `<code>${escapeHtml(r.constraints_json?.slice(0, 60) ?? "")}</code>`,
            r.created_at
          ].map(v => `<td>${v}</td>`).join("");
          tbody.appendChild(tr);
        }

        $("lookupMsg").textContent = "✓ Found " + rows.length + " policies";
        $("lookupMsg").style.color = 'var(--success)';
      } catch (e) {
        $("lookupMsg").textContent = "Error: " + e.message;
        $("lookupMsg").style.color = 'var(--error)';
      }
    };

    function escapeHtml(str) {
      return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    // Trigger initial policy type display
    $("policyType").dispatchEvent(new Event('change'));
  </script>
</body>
</html>

